<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJM3PrZ_vexsXzcZH2Ixhn1TzRbTMoNA7p-ZzvfFyVXPFJDN6zMAUfM5p0KzVH9A3K9A/exec";

  function loadResult() {
    const examId = document.getElementById("examInput").value.trim();
    if (!examId) return alert("يرجى إدخال الرقم الامتحاني");

    fetch(`${SCRIPT_URL}?id=${encodeURIComponent(examId)}`)
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          const map = {
            missing_id: "يرجى إدخال الرقم الامتحاني",
            stage_not_found: "الرقم لا ينتمي لأي مرحلة",
            sheet_not_found: "لم يتم العثور على ورقة المرحلة المحددة",
            empty_sheet: "الورقة فارغة أو غير جاهزة",
            headers_missing: "عناوين الأعمدة غير مطابقة (تحقق من: الرقم الامتحاني، الاسم، ملاحظة/ملاحظات، حالة النتيجة)",
            not_found: "الرقم غير موجود"
          };
          alert(map[data.error] || "تعذر جلب البيانات. تأكد من نشر السكربت وضبط الصلاحيات.");
          return;
        }

        document.getElementById("studentName").innerText = data.name || "---";
        document.getElementById("examId").innerText = data.examId || examId;

        let stage = "---";
        if (!isNaN(parseInt(examId, 10))) {
          const num = parseInt(examId, 10);
          if (num >= 455 && num <= 598) stage = "المرحلة الثانية";
          else if (num >= 33 && num <= 453) stage = "المرحلة الثالثة";
        }
        document.getElementById("studentStage").innerText = stage;

        if (!data.subjects || data.subjects.length === 0) {
          document.getElementById("subjectsTableWrapper").style.display = "none";
          document.getElementById("noteText").innerText = data.note || "⚠️ تم حجب النتيجة من قبل القسم، راجع القسم";
        } else {
          const tableBody = document.getElementById("subjectsTable");
          tableBody.innerHTML = "";
          data.subjects.forEach(sub => {
            const row = document.createElement("tr");
            row.innerHTML = `<td>${sub.name}</td><td>${sub.grade}</td>`;
            tableBody.appendChild(row);
          });
          document.getElementById("subjectsTableWrapper").style.display = "table";
          document.getElementById("noteText").innerText = data.note || "لا توجد ملاحظة";
        }

        document.getElementById("resultCard").style.display = "block";
      })
      .catch(() => alert("تعذر جلب البيانات. تأكد من نشر السكربت وضبط الصلاحيات."));
  }

  function printResult() {
    const printContents = document.getElementById("resultCard").innerHTML;
    const originalContents = document.body.innerHTML;
    document.body.innerHTML = printContents;
    window.print();
    document.body.innerHTML = originalContents;
    location.reload();
  }
</script>
