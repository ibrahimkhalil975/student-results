<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨ - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù‡Ø§Ø¯ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {font-family:"Cairo","Tahoma",sans-serif;direction:rtl;background:#f9f9f9;margin:0;padding:0;}
    header {background:#004080;color:#fff;text-align:center;padding:20px;}
    header h1 {margin:5px 0;font-size:24px;}
    header h2 {margin:5px 0;font-size:20px;}
    header h3 {margin:5px 0;font-size:18px;}
    main {padding:20px;max-width:800px;margin:auto;}
    input, button {padding:10px;font-size:16px;margin:5px;width:100%;box-sizing:border-box;}
    .card {background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1);margin-top:20px;}
    table {width:100%;border-collapse:collapse;margin-top:10px;}
    th, td {border:1px solid #ccc;padding:8px;text-align:center;}
    th {background:#004080;color:#fff;}
    .note {color:red;font-weight:bold;margin-top:10px;}
    .btn-group {display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .btn {flex:1;padding:10px;border:none;border-radius:5px;cursor:pointer;font-size:16px;}
    .btn-print {background:#28a745;color:#fff;}
    .btn-pdf {background:#007bff;color:#fff;}
    footer {text-align:center;padding:15px;background:#eee;margin-top:20px;font-weight:bold;}
  </style>
</head>
<body>
  <header>
    <h1>Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù‡Ø§Ø¯ÙŠ</h1>
    <h2>Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ©</h2>
    <h3>Ù‚Ø³Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</h3>
  </header>

  <main>
    <h2>ğŸ“‹ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</h2>
    <input type="text" id="examInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†">
    <button onclick="loadResult()">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>

    <div id="resultCard" class="card" style="display:none;">
      <p>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: <span id="studentName">---</span></p>
      <p>ğŸ†” Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠ: <span id="examId">---</span></p>

      <table id="subjectsTableWrapper" style="display:none;">
        <thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead>
        <tbody id="subjectsTable"></tbody>
      </table>

      <p class="note">ğŸ“Œ Ù…Ù„Ø§Ø­Ø¸Ø©: <span id="noteText">---</span></p>

      <div class="btn-group">
        <button class="btn btn-print" onclick="printResult()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        <button class="btn btn-pdf" onclick="savePDF()">ğŸ’¾ Ø­ÙØ¸ PDF</button>
      </div>
    </div>
  </main>

  <footer>
    Ù…Ø¹ ØªØ­ÙŠØ§Øª Ù…. Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø®Ù„ÙŠÙ„ ÙƒØ§Ù…Ù„
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxb8Ok7B_PMbdACBmfrsDzcS9zg64DnnLXtbG4OQcq9zwvQyfyWFfUGsTQoICb6gOe9bg/exec";

    function loadResult() {
      const examId = document.getElementById("examInput").value.trim();
      if (!examId) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠ");

      fetch(`${SCRIPT_URL}?id=${encodeURIComponent(examId)}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            const map = {
              missing_id: "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠ",
              stage_not_found: "Ø§Ù„Ø±Ù‚Ù… Ù„Ø§ ÙŠÙ†ØªÙ…ÙŠ Ù„Ø£ÙŠ Ù…Ø±Ø­Ù„Ø©",
              sheet_not_found: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©",
              headers_missing: "Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø©",
              not_found: "Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
            };
            alert(map[data.error] || "ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
            return;
          }

          document.getElementById("studentName").innerText = data.name || "---";
          document.getElementById("examId").innerText = data.examId || examId;

          const tableBody = document.getElementById("subjectsTable");
          tableBody.innerHTML = "";
          if (!data.subjects || data.subjects.length === 0) {
            document.getElementById("subjectsTableWrapper").style.display = "none";
            document.getElementById("noteText").innerText = data.note || "âš ï¸ ØªÙ… Ø­Ø¬Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø³Ù…ØŒ Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù‚Ø³Ù…";
          } else {
            data.subjects.forEach(sub => {
              if (sub.grade !== "" && sub.grade !== null) {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${sub.name}</td><td>${sub.grade}</td>`;
                tableBody.appendChild(row);
              }
            });
            document.getElementById("subjectsTableWrapper").style.display = "table";
            document.getElementById("noteText").innerText = data.note || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø©";
          }

          document.getElementById("resultCard").style.display = "block";
        })
        .catch(() => alert("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"));
    }

    function printResult() {
      const printContents = document.getElementById("resultCard").innerHTML;
      const originalContents = document.body.innerHTML;
      document.body.innerHTML = printContents;
      window.print();
      document.body.innerHTML = originalContents;
      location.reload();
    }

    async function savePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation: "portrait", unit: "mm", format: "a4"});
      doc.setFont("Helvetica","normal");
      doc.setFontSize(14);

      doc.text("Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù‡Ø§Ø¯ÙŠ - Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© - Ù‚Ø³Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·Ø¨ÙŠØ©", 10, 20);
      doc.text("Ø§Ù„Ø§Ø³Ù…: " + document.getElementById("studentName").innerText, 10, 35);
      doc.text("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ÙŠ: " + document.getElementById("examId").innerText, 10, 45);

      let y = 60;
      doc.setFontSize(12);
      doc.text("Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª:", 10, y);
      y += 10;

      const rows = document.querySelectorAll("#subjectsTable tr");
      rows.forEach(row => {
        const cols = row.querySelectorAll("td");
        if (cols.length === 2 && cols[1].innerText.trim() !== "") {
          doc.text(`${cols[0].innerText} : ${cols[1].innerText}`, 10, y);
          y += 8;
        }
      });

      y += 10;
      doc.text("Ù…Ù„Ø§Ø­Ø¸Ø©: " + document.getElementById("noteText").innerText, 10, y);
      y += 20;
      doc.text("Ù…Ø¹ ØªØ­ÙŠØ§Øª Ù…. Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø®Ù„ÙŠÙ„ ÙƒØ§Ù…Ù„", 10, y);

      doc.save("Ù†ØªÙŠØ¬Ø©_" + document.getElementById("examId").innerText + ".pdf");
    }
  </script>
</body>
</html>
