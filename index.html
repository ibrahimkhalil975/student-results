function doGet(e) {
  var examId = (e && e.parameter && e.parameter.id || "").trim();
  if (!examId) return jsonOut({ error: "missing_id" });

  var num = parseInt(examId, 10);
  var ss = SpreadsheetApp.openByUrl("https://docs.google.com/spreadsheets/d/1RPpj2NcEm_1smbolDgZsabwkqVfSZRD7b0kDczU5-Qs/edit");

  var SECOND_STAGE_GID = 1222770986;   // ورقة المرحلة الثانية
  var THIRD_STAGE_GID  = 1378396221;   // ورقة المرحلة الثالثة الجديدة

  var sheet;
  if (num >= 455 && num <= 598) {
    sheet = ss.getSheetById(SECOND_STAGE_GID);
  } else if (num >= 33 && num <= 453) {
    sheet = ss.getSheetById(THIRD_STAGE_GID);
  } else {
    return jsonOut({ error: "stage_not_found" });
  }

  var data = sheet.getDataRange().getValues();
  var headers = data[0].map(h => h.toString().trim());

  function findHeader(possibleNames) {
    for (var i = 0; i < possibleNames.length; i++) {
      var idx = headers.indexOf(possibleNames[i]);
      if (idx !== -1) return idx;
    }
    return -1;
  }

  var idxExam   = findHeader(["رقم الامتحان","الرقم الامتحاني"]);
  var idxName   = findHeader(["الاسم","اسم الطالب"]);
  var idxNote   = findHeader(["ملاحظة","ملاحظات"]);
  var idxStatus = findHeader(["حالة النتيجة"]);

  if (idxExam === -1 || idxName === -1 || idxNote === -1 || idxStatus === -1) {
    return jsonOut({ error: "headers_missing" });
  }

  var subjectIndices = [];
  for (var c = 0; c < headers.length; c++) {
    if (![idxExam, idxName, idxNote, idxStatus].includes(c)) {
      subjectIndices.push(c);
    }
  }

  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    if ((row[idxExam] || "").toString().trim() === examId) {
      var status = row[idxStatus];
      var note = (row[idxNote] || "").toString().trim();
      var name = (row[idxName] || "").toString().trim();

      if (String(status) === "0") {
        return jsonOut({
          name: name,
          examId: examId,
          subjects: [],
          note: "⚠️ تم حجب النتيجة من قبل القسم، راجع القسم"
        });
      }

      var subjects = subjectIndices.map(col => ({
        name: headers[col],
        grade: row[col]
      }));

      return jsonOut({
        name: name,
        examId: examId,
        subjects: subjects,
        note: note || ""
      });
    }
  }

  return jsonOut({ error: "not_found" });
}

function jsonOut(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
